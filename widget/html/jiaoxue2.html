<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="../css/aui.css">
    <link rel="stylesheet" href="../css/iconfont/iconfont.css">
</head>
<style media="screen">
    header {
        position: fixed !important;
        width: 100%;
        font-size: 1rem;
    }

    header i {
        color: #222222;
        font-size: 1rem !important;
        font-weight: 600;
    }

    .db {
        background: #fff;
        line-height: 1.5rem;
    }

    .color-33 {
        color: #333;
    }

    .color-99 {
        color: #999;
    }

    .color-22 {
        color: #222;
    }

    .color-76 {
        color: #76D166;
    }

    .color-ff {
        color: #ff6655;
    }

    .aui-hr {
        background-size: 90% 1px;
    }

    .aui-padded-15 img {
        margin: 0 auto;
    }

    .main_3 i {
        float: right;
        font-size: 1rem !important;
    }

    .main_3 p {
        color: #222;
        font-size: 0.75rem;
    }

    .main_3 {
        width: 100%;
        background: #fff;
        margin: 1rem auto;
        font-size: 0.8rem;
        height: 2.5rem;
        line-height: 2.5rem;
    }

    .pad {
        padding-top: 3.5rem;
    }

    .title {
        height: 3rem;
        line-height: 3rem;
        padding-left: 1rem;
    }

    .con {
        background: #F9F9F9;
    }

    .nr {
        background: #fff;
        height: 2.5rem;
        line-height: 2.5rem;
    }

    .bm {
        width: 100%;
        height: 2.5rem;
        line-height: 2.5rem;
    }

    .bm p {
        float: left;
    }

    .bm i {
        font-size: 1rem;
    }

    .xm {
        background: #fff;
        overflow: hidden;
        height: auto;
    }

    .xm p {
        display: block;
        line-height: 2rem;
        height: 2rem;
    }

    .cn {}

    .cn_nav {
        height: 2.5rem;
        line-height: 2.5rem;
        background-color: #fff;
    }

    .ds_con {
        background: #fff;
    }

    .bt {
        text-align: center;
        background: #fff;
        padding: 0.5rem 0 0.5rem 0;
        position: relative;
        bottom: 0;
        width: 100%;
    }

    .bt button {
        width: 80%;
        text-align: center;
        border-radius: 4px;
        height: 2.5rem;
        font-size: 0.85rem;
        outline: none;
        border: 0;
        background: #4593de;
        color: #fff;
    }

    .upload {
        height: 2.5rem;
        line-height: 2.5rem;
        background-color: #fff;
    }
</style>

<body>
    <header class="aui-bar aui-bar-nav" id="header">
        <a class="aui-pull-left" tapmode onclick="fh()">
            <i class="iconfont icon-arrow-left aui-iconfont"></i>
        </a>
        <div class="aui-title">教学活动</div>
    </header>
    <div class="pad"></div>
    <div class="jx">
        <div class="db ">
            <div class="title">
                <p class="aui-font-size-18 color-22 chu" id="name">{{text.name}}</p>
            </div>
            <div class="aui-padded-15 con">
                <p class="aui-font-size-16 color-33" id="content">{{text.content}}</p>
            </div>
        </div>

        <div class="cn">
            <div class="cn_nav">
                <p class="aui-font-size-16 aui-padded-l-15 clo-33">病人姓名:<span class="aui-pull-right aui-padded-r-15" id="patient_name">{{text.patient_name}}</span></p>
                <div class="aui-hr"></div>
            </div>
            <div class="cn_nav ">
                <p class="aui-font-size-16 aui-padded-l-15 clo-33">病历号:<span class=" aui-pull-right aui-padded-r-15" id="record_num">{{text.record_num}}</span></p>
            </div>
        </div>
        <div class="Diagnosis aui-margin-t-15">
            <div class="cn_nav ">
                <p class="aui-font-size-16 aui-padded-l-15 clo-33">入院诊断</p>
                <div class="aui-hr"></div>
            </div>
            <div class="ds_con aui-padded-10">
                <p class="aui-font-size-16 clo-33" id="diagnosis">{{text.diagnosis}}</p>
            </div>
        </div>
        <div class="aui-margin-t-15  aui-margin-b-15">
            <div class="nr ">
                <p class="aui-font-size-16 clo-33 aui-padded-l-15"> 主讲人：<span id="speaker">{{text.speaker}}</span></p>
                <div class="aui-hr"></div>
            </div>

            <div class="nr ">
                <p class="aui-font-size-16 clo-33  aui-padded-l-15"> 活动时间：<span id="date">{{text.date}}</span></p>
                <div class="aui-hr"></div>
            </div>
            <div class="nr  ">
                <p class="aui-font-size-16 clo-33  aui-padded-l-15"> 活动形式：<span id="typename">{{text.typename}}</span></p>
                <div class="aui-hr"></div>
            </div>
            <div class="nr  ">
                <p class="aui-font-size-16 clo-33  aui-padded-l-15"> 课时：<span id="hours">{{text.hours}}</span></p>
                <div class="aui-hr"></div>
            </div>
            <div class="nr  ">
                <p class="aui-font-size-16 clo-33  aui-padded-l-15"> 发布日期：<span id="create_at">{{text.create_at}}</span></p>
                <div class="aui-hr"></div>
            </div>
            <div class="nr">
                <p class="aui-font-size-16 clo-33  aui-padded-l-15"> 活动地点：<span id="address">{{text.address}}</span></p>
            </div>
            <div class="upload aui-margin-t-15 aui-padded-l-10" tapmode v-on:click="upload(text.sign_status)">
                <p class="aui-font-size-16 clo-33 aui-pull-left">上传佐证<span class=" aui-font-size-14 clo-99 aui-padded-l-10" id="zz"> 点击上传佐证</span></p>
                <i class="iconfont icon-upload aui-pull-right aui-padded-r-15 aui-font-size-18 clo-33"></i>
            </div>
        </div>
        <div class="nr">
            <div class="bm" tapmode onclick="cyry()">
                <i class="iconfont icon-about-us aui-pull-left color-76 aui-font-size-20 aui-padded-l-5 aui-padded-r-15"></i>
                <p class="aui-font-size-16 color-22">已报名参加人员(<span class="clo-99" id="sign_users_num">{{text.sign_users_num}}人</span>)</p>
                <i class="iconfont icon-arrow-right aui-pull-right clo-22 aui-padded-r-10"></i>
            </div>
            <!-- <div class="aui-hr"></div> -->
        </div>
        <div class="xm" id="xm">
            <div v-for="item in list">
                <p class="aui-font-size-14 color-33 aui-col-xs-3 aui-text-center"> {{item.name}}</p>
            </div>
        </div>
        <!-- 我的评价 -->
        <!-- <div class="main_3">
            <i class="iconfont icon-news-s  color-ff aui-pull-left aui-padded-l-10 aui-padded-r-10"></i>
            <i class="iconfont icon-arrow-right aui-pull-right clo-22 aui-padded-r-10"></i>
            <p class="aui-text-left">我的评价</p>
        </div> -->

        <div class=" bt aui-margin-t-15">
            <button v-if="text.sign_status == 0 " v-on:click="join()">参加活动</button>
            <button v-if="text.sign_status == 1 ">已参加等待带教同意</button>
            <button type="button" name="button" v-if="text.sign_status == 2" v-on:click="pj(text.id,text.type)">评价活动</button>
            <button v-if="text.sign_status == 3" v-on:click="check(text.e_id,text.type)">查看评价</button>
        </div>
    </div>
</body>
<script src="../script/api.js"></script>
<script src="../script/AHelper.js"></script>
<script src="../script/aui-dialog.js"></script>
<script src="../script/aui-toast.js"></script>
<script src="../script/base.js"></script>
<script src="../script/zepto.min.js"></script>
<script src="../script/vue/vue.min.js"></script>
<script>
    var vm = new Vue({
        el: ".jx",
        data: {
            text: {},
            list: []
        },
        methods: {
            pj: function(id, type) {
                H.setStorage("jxpj_id", id);
                H.setStorage("jxpj_type", type);
                api.openWin({
                    name: 'jxpj',
                    url: './jxpingjia.html',
                    pageParam: {
                        name: 'test'
                    }
                });
            },
            join: () => {
                api.confirm({
                    title: '教学活动',
                    msg: '是否参加该场活动',
                    buttons: ['确定', '取消']
                }, function(ret, err) {
                    if (ret.buttonIndex == 1) {
                        var address = "/Hospital/index.php/api/ys/teaching_activities";
                        var token = H.getStorage('token');
                        var jx_id = H.getStorage('jx_id');
                        var ajaxData = {
                            token: token,
                            action: 'sign',
                            teach_id: jx_id,
                        };
                        $base.get(address, ajaxData, function(ret) {
                            console.log(JSON.stringify(ret));
                            if (ret.status == 1) {
                                $base.toast(ret.errmsg);
                                setTimeout(function() {
                                    location.reload();
                                }, 1000)
                            } else {
                                $base.toast(ret.errmsg);
                            }
                        });
                    } else {
                        console.log(JSON.stringify(err));
                    }
                });

            },
            upload: (sign_status) => {
                if (sign_status == 2) {
                    api.getPicture({
                        sourceType: 'library',
                        encodingType: 'jpg',
                        mediaValue: 'pic',
                        destinationType: 'url',
                        allowEdit: true,
                        quality: 100,
                        saveToPhotoAlbum: false
                    }, function(ret, err) {
                        console.log(JSON.stringify(ret.data));
                        if (ret) {
                            var token = H.getStorage("token");
                            var id = H.getStorage("jx_id")
                            console.log(id);
                            var address = "/Hospital/index.php/api/ys/teaching_activities";
                            var ajaxData = {
                                token: token,
                                photoimg: ret.data,
                                action: "update_photo",
                                id: id,

                            };

                            $base.submit(address, ajaxData, function(ret) {
                                console.log(JSON.stringify(ret));
                                if (ret.status == 1) {
                                    $base.toast(ret.errmsg);
                                    $("#zz").html("已上传佐证")
                                    $("#zz").addClass("clo-lan")
                                } else {
                                    $base.toast(ret.errmsg);
                                }
                            });
                        } else {
                            console.log(JSON.stringify(err));
                        }
                    });
                } else {
                    $base.toast("请参加活动后再提交佐证！！")
                }

            },
            check: (eid, type) => {
                H.setStorage('jxpj_eid', eid);
                alert(eid)
                H.setStorage("jxpj_type", type);
                api.openWin({
                    name: 'jxpj2',
                    url: '../html/jxpingjia2.html',
                    pageParam: {
                        name: 'test'
                    }
                });
            }
        }
    })

    function fh() {
        api.closeWin({});
    }

    function cyry() {
        H.setStorage("panduan", "jx");
        api.openWin({
            name: 'cyry',
            url: './canyury.html',
            pageParam: {
                name: 'test'
            }
        });

    }


    H.ready(function() {
        var address = "/Hospital/index.php/api/ys/teaching_activities";
        var token = H.getStorage('token');
        var id = H.getStorage("jx_id");
        console.log(id);
        $base.showLoading();
        var ajaxData = {
            token: token,
            id: id,
            action: "detail",
        };
        $base.get(address, ajaxData, function(ret) {
            console.log(JSON.stringify(ret));
            var dd = ret.data.sign_users.slice(0, 8);
            vm.list = dd;
            vm.text = ret.data;
            $base.closeLoading();
            if (ret.data.photo_url_student != "") {
                $("#zz").html("已上传佐证")
                $("#zz").addClass("clo-lan")
            } else {
                console.log("未上传佐证");
            }
        }, function(err) {
            console.log(JSON.stringify(err));
        });
    })
</script>

</html>
